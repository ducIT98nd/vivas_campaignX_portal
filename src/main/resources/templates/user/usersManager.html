<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head th:replace="common/head :: head"></head>
<style>
    .onoffswitch-inner:before {
        content: "Hoạt động" !important;
        padding-left: 20px !important;
    }
    .onoffswitch-inner:after {
        content: "Tạm dừng" !important;
        padding-right: 20px !important;
    }
    .onoffswitch{
        width: 120px !important;
    }
    .onoffswitch-switch {
        right: 83px;
    }

    .custom-select {
        background-color: #fff;
    }

    .modal-table td{
        vertical-align: middle!important;
        border: none !important;;
    }
    .btn {
        padding: 8px 12px !important;
        font-size: 16px !important;
    }
</style>
<body class="fix-header card-no-border">

<!-- Preloader - style you can find in spinners.css -->
<div class="preloader">
    <svg class="circular" viewBox="25 25 50 50">
        <circle class="path" cx="50" cy="50" fill="none" r="20" stroke-miterlimit="10" stroke-width="2"/>
    </svg>
</div>

<!-- Main wrapper - style you can find in pages.scss -->
<div id="main-wrapper">

    <div th:replace="common/bodyHeader"></div>

    <!-- Left Sidebar - style you can find in sidebar.scss  -->
    <div th:replace="common/leftmenu"></div>

    <div class="page-wrapper">
        <!-- Container fluid  -->
        <div class="container-fluid">
            <div class="row pd-r-ctn">
                <div class="col-12">
                        <div class="card" style="margin: 0 15px">
                            <div class="card-block">
                                <div class="row smal_title">
                                    <h4 class="card-title col-lg-6 d-flex"><i class="fa fa-user"></i>Danh sách Tài khoản</h4>
                                    <div class="title_btn col-1g-6">
                                        <div class="btn-group">
                                            <button type="button" id="addUsers" onclick="addUser()" class="btn btn-rounded btn-primary"><i class="ti-plus text" aria-hidden="true"></i>Thêm mới</button>
                                        </div>
                                        <div class="btn-group">
                                            <button type="button"
                                            class="btn btn-rounded btn-outline-primary"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"  onclick="exportUser()">
                                            <i class="icon-share-alt"></i> Xuất danh sách
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive m-t-10">
                                    <form th:action="@{/UsersController/usersManager}" id="mainForm" class="form" method="get">
                                        <div class="row search_table">
                                            <div class="col-md-10">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="control-label">Tên đăng nhập</label>
                                                            <input type="text" id="username" name="username" th:value="${username}" class="form-control" maxlength="20" placeholder="Nhập tên đăng nhập">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <div class="form-group">
                                                                <label class="control-label">Email</label>
                                                                <input type="text" id="email" name="email" th:value="${email}" class="form-control"  maxlength="100" placeholder="Nhập địa chỉ email">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="control-label">Vai trò</label>
                                                            <select class="form-control custom-select" id="role" name="roleID">
                                                                <option value="">Tất cả</option>
                                                                <th:block th:each="item,loop : ${roles}">
                                                                    <option th:value="${item.getRoleId()}"
                                                                            th:text="${item.getRoleName()}"
                                                                            th:selected="${roleID}==${item.getRoleId()}">
                                                                    </option>
                                                                </th:block>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="control-label">Trạng thái</label>
                                                            <select class="form-control custom-select" id="status" name="status">
                                                                <option th:selected="${status}==2" value="2">Tất cả</option>
                                                                <option th:selected="${status}==1" value="1">Hoạt động</option>
                                                                <option th:selected="${status}==0" value="0">Khóa</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-2 btn_search">
                                                <div class="btn-group">
                                                    <button type="submit" style="border-bottom-right-radius: 60px !important; border-top-right-radius: 60px !important; " class="btn btn-rounded btn-primary"id="findUsers"><i class="ti-search"></i> Tìm kiếm</button>
                                                    <input id="csrf-input" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                                </div>
                                            </div>
                                        </div>
                                    </form>

                                    <div class="row form_qldhqc">
                                        <div class="col-sm-12 col-xs-12">
                                            <div class="table-responsive">
                                                <table class="table">
                                                    <thead>
                                                    <tr class="text-center">
                                                        <th style="width: 4%; text-align: center">#</th>
                                                        <th style="text-align: center">Tên đăng nhập</th>
                                                        <th style="text-align: center">Tên người dùng</th>
                                                        <th style="text-align: center">Vai trò</th>
                                                        <th style="text-align: center">Email</th>
                                                        <th style="width: 10%; text-align: center">Trạng thái</th>
                                                        <th style="width: 10%; text-align: center">Thao tác</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    <tr th:if="${totalPages == 0}">
                                                        <td th:if="${totalPages == 0}" colspan="15" class="font-bold text-center">Không tìm thấy tài khoản phù hợp</td>
                                                    </tr>
                                                    <tr th:each="user,loop : ${usersPage.getContent()}">
                                                        <td> <div class="scroll-inline text-left" th:text="${loop.index+1+(currentPage-1)*pageSize}"></div></td>
                                                        <td><div class="scroll-inline text-left" th:text="${user.getUsername()}"></div></td>
                                                        <td><div class="scroll-inline text-left" th:text="${user.getName()}"></div></td>
                                                        <td class="scroll-inline text-left" th:text="${user.getRoleName()}"></td>
                                                        <td><div class="scroll-inline text-left" th:text="${user.getEmail()}"></div></td>
                                                        <td class="scroll-inline text-left" th:text="${user.getStatus()} ? 'Hoạt Động' : 'Khóa'"></td>
                                                        <td class="act_ksn">
                                                            <div class="btn-group">
                                                                <button sec:authorize="hasAnyAuthority('detail:user')"
                                                                   type="button" class="btn btn_ksn btn_ksn_delete btn_cl_black detail-user"
                                                                   title="Xem" th:attr="data-userid=${user.getUserId()}">
                                                                    <i class="eye_ic"></i>
                                                                </button>
                                                                <button sec:authorize="hasAnyAuthority('update:user')"
                                                                   type="button" class="btn btn_ksn btn_ksn_delete btn_cl_black update-user"
                                                                   title="Sửa" id="change-password" th:attr="data-userid=${user.getUserId()}">
                                                                    <i class="edit_ic"></i>
                                                                </button>
                                                                <button sec:authorize="hasAnyAuthority('delete:user')"
                                                                        type="button" class="btn btn_ksn btn_ksn_delete btn_cl_black detele-user"
                                                                   title="Xóa" th:attr="data-userid=${user.getUserId()}, data-username=${user.getUsername()}">
                                                                    <i class="trash_ic"></i>
                                                                </button>
                                                                <button sec:authorize="hasAnyAuthority('renew:user')" type="button" class="btn btn_ksn btn_ksn_delete btn_cl_black renew-password"
                                                                   title="Cấp lại mật khẩu" th:attr="data-userid=${user.getUserId()}, data-name=${user.getName()}, data-username=${user.getUsername()}">
                                                                    <i class="icon-key"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    </tbody>
                                                </table>

                                                <div class="float-right m-t-20">
                                                    <nav aria-label="Page navigation">
                                                        <ul class="pagination-sm" id="pagination"></ul>
                                                    </nav>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
        <!-- footer -->
        <footer class="footer">
            Bản quyền thuộc về Công ty TNHH Cung cấp Giải pháp Dịch vụ Giá trị gia tăng <span class="red-clr">VIVAS</span>
        </footer>
        <!-- End footer -->
    </div>
    <!-- End Page wrapper  -->
    <div th:insert="common/footer" th:remove="tag"></div>

    <div id="modal-add-new-user" data-backdrop="static" data-keyboard="false" class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info-header shadow-sm">
                    <h3 class="modal-title text-themecolor rounded">Thêm tài khoản mới</h3>
                </div>
                <form id="form-add-user" th:action="@{/UsersController/submitCreateUser}"  method="post">
                    <div class="modal-body">
                        <table class="table table-hover modal-table">
                            <tbody>
                            <tr>
                                <td>Tên đăng nhập: <span class="text-danger">(*)</span></td>
                                <td>
                                    <div class="form-group" style="margin-bottom: 0px">
                                        <input maxlength="20" type="text" name="username" id="username-add" class="form-control" placeholder="Nhập tên đăng nhập"/>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Tên người dùng: <span class="text-danger">(*)</span></td>
                                <td>
                                    <div class="form-group" style="margin-bottom: 0px">
                                        <input maxlength="100" type="text" name="name" id="name-add" class="form-control" placeholder="Nhập tên người dùng"/>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Email: <span class="text-danger">(*)</span></td>
                                <td>
                                    <div class="form-group" style="margin-bottom: 0px">
                                        <input maxlength="100" type="text" name="email" id="email-add" class="form-control" placeholder="Nhập địa chỉ email"/>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Vai trò: <span class="text-danger">(*)</span></td>
                                <td>
                                    <select id="role-add" name="roleId" class="form-control custom-select">
                                        <th:block th:each="item,loop : ${roles}">
                                            <option th:value="${item.getRoleId()}"
                                                        th:text="${item.getRoleName()}"
                                                        th:selected="${roleID}==${item.getRoleId()}">
                                            </option>
                                        </th:block>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>Mật khẩu:<span class="text-danger">(*)</span> </td>
                                <td>
                                    <div class="form-group" style="margin-bottom: 0px">
                                        <input type="password" name="password" id="password-add" class="form-control" placeholder="Nhập mật khẩu"/>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Xác nhận mật khẩu: <span class="text-danger">(*)</span></td>
                                <td>
                                    <div class="form-group" style="margin-bottom: 0px">
                                        <input type="password" name="confirmPassword" id="confirm-password-add" class="form-control" placeholder="Nhập lại mật khẩu"/>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Trạng thái: <span class="text-danger">(*)</span></td>
                                <td>
                                    <select class="form-control custom-select" name="status" tabindex="1" id="status-add" >
                                        <option value="1">Hoạt động</option>
                                        <option value="0">Khóa</option>
                                    </select>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <input type="hidden" id="is-valid-info-add" value="0">
                </form>
                <div class="modal-footer">
                    <button type="button" class="btn btn-rounded btn-danger" onclick="closeModel('modal-add-new-user','Bạn muốn hủy thêm mới tài khoản?')">Hủy</button>
                    <button type="button" onclick="validateAddUser()"  class="btn btn-primary">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-detail-user" data-backdrop="static" data-keyboard="false" class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info-header shadow-sm">
                    <h3 class="modal-title text-themecolor rounded">Xem thông tin tài khoản</h3>
                </div>
                <form>
                    <div class="modal-body">
                        <table class="table table-hover modal-table">
                            <tbody>
                            <tr>
                                <td>Tên đăng nhập:</td>
                                <td id="detail-username"></td>
                            </tr>
                            <tr>
                                <td>Tên người dùng:<span class="text-danger">(*)</span></td>
                                <td id="detail-name"></td>
                            </tr>
                            <tr>
                                <td>Email:<span class="text-danger">(*)</span></td>
                                <td id="detail-email"></td>

                            </tr>
                            <tr>
                                <td>Vai trò:<span class="text-danger">(*)</span></td>
                                <td id="detail-role">
                                </td>
                            </tr>
                            <tr>
                                <td>Trạng thái:</td>
                                <td id="detail-status">
                                </td>
                                <input type="hidden" name="userId" id="userid-detail">
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </form>
                <div class="modal-footer">
                    <button type="button" class="btn btn-rounded btn-danger" data-dismiss="modal">Hủy</button>
                    <button type="button" onclick="update()" class="btn btn-primary">Sửa</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-update-user" data-backdrop="static" data-keyboard="false" class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info-header shadow-sm">
                    <h3 class="modal-title text-themecolor rounded">Chỉnh sửa thông tin tài khoản</h3>

                </div>
                <form>
                    <div class="modal-body">
                        <table class="table table-hover modal-table">
                            <tbody>
                            <tr>
                                <td>Tên đăng nhập:</td>
                                <td >
                                    <input maxlength="100" type="text" name="update-username" id="update-username" class="form-control" disabled/>
                                </td>
                            </tr>
                            <tr>
                                <td>Tên người dùng:<span class="text-danger">(*)</span></td>
                                <td class="form-group" style="margin-bottom: 0px">
                                    <input maxlength="100" type="text" name="name" id="name-update" class="form-control" />
                                </td>
                            </tr>
                            <tr>
                                <td>Email:<span class="text-danger">(*)</span></td>
                                <td class="form-group" style="margin-bottom: 0px">
                                    <input maxlength="100" type="text" name="name" id="email-update" class="form-control" />
                                </td>

                            </tr>
                            <tr>
                                <td>Vai trò:<span class="text-danger">(*)</span></td>
                                <td class="form-group" style="margin-bottom: 0px">
                                    <select id="role-update" name="roleId" class="form-control custom-select">
                                        <th:block th:each="item,loop : ${roles}">
                                            <option th:value="${item.getRoleId()}"
                                                    th:text="${item.getRoleName()}"
                                                    >
                                            </option>
                                        </th:block>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>Trạng thái:</td>
                                <td>
                                    <select class="form-control custom-select" name="status" tabindex="1" id="status-update" >
                                        <option value="1">Hoạt động</option>
                                        <option value="0">Khóa</option>
                                    </select>
                                </td>
                                <input type="hidden" name="userId" id="userid-update">
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <input type="hidden" id="is-valid-info-update" value="0">
                </form>
                <div class="modal-footer">
                    <button type="button" class="btn btn-rounded btn-danger" onclick="closeModel('modal-update-user','Bạn muốn hủy chỉnh sửa thông tin tài khoản?')">Hủy</button>
                    <button type="button" onclick="validateUpdateUser()" class="btn btn-primary">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-renew-password" data-backdrop="static" data-keyboard="false" class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info-header shadow-sm">
                    <h3 class="modal-title text-themecolor rounded text-center">Cấp lại mật khẩu</h3>

                </div>
                <form id="form-renew-password" th:action="@{/UsersController/renewPassword}" method="post">
                    <div class="modal-body">
                        <table class="table table-hover modal-table">
                            <tbody>
                            <tr>
                                <td>Tên đăng nhập:</td>
                                <td >
                                    <input type="text" name="username-renew-password" id="username-renew-password" class="form-control" disabled/></td>
                            </tr>
                            <tr>
                                <td>Mật khẩu mới: <span class="text-danger">(*)</span></td>
                                <td>
                                    <div class="form-group" style="margin-bottom: 0px">
                                        <input type="password" name="password" id="password-renew" class="form-control"/>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Xác nhận mật khẩu: <span class="text-danger">(*)</span></td>
                                <td>
                                    <div class="form-group" style="margin-bottom: 0px">
                                        <input type="password" name="passwordConfirm" id="passwordConfirm-renew" class="form-control"/>
                                    </div>
                                </td>
                                <input type="hidden" name="userId" id="userid-renew-password">
                            </tr>
                            </tbody>
                        </table>
                        <div class="text-center">
                            <p class="text-danger" id="renew-password-result"></p>
                            <small><i class="text-danger">Mật khẩu chứa ít nhất 6 ký tự bao gồm số, chữ hoa, chữ thường và ký tự đặc biệt</i></small>
                        </div>
                    </div>
                </form>
                <div class="modal-footer">
                    <button type="button" class="btn btn-rounded btn-danger" onclick="closeModel('modal-update-user','Bạn muốn hủy cấp lại mật khẩu tài khoản?')">Hủy</button>
                    <button form="form-renew-password" type="button" onclick="validateRenewPassword()" class="btn btn-primary">Lưu</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:if="${alertMessage!=null}" th:inline="javascript">
    Swal.fire({
        position: 'top',
        type: 'success',
        title: 'Campaign X Thông báo',
        text: [[${alertMessage}]]
    })
</script>

<div th:insert="common/templates::pagination"></div>

<script>


    // $(document).ready(function() {
    //     $('#modal-update-user').on('hide.bs.modal', function (event) {
    //         let isValidData = $("#is-valid-info-update").val();
    //         if(isValidData == 0){
    //             if(!confirm("Bạn muốn hủy chỉnh sửa thông tin tài khoản?")){
    //                 event.preventDefault();
    //             }
    //         }
    //     });
    //     $('#modal-add-new-user').on('hide.bs.modal', function (event) {
    //         let isValidData = $("#is-valid-info-add").val();
    //         if(isValidData == 0){
    //             if(!confirm("Bạn muốn hủy thêm tài khoản mới?")){
    //                 event.preventDefault();
    //             }
    //         }
    //     });
    //
    // });

    function closeModel(id, message) {
        Swal.fire({
            position: 'top',
            title: 'Thông báo',
            text: message,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'OK',
            cancelButtonText: 'HỦY'
        }).then((result) => {
            if (result.value) {
                $('#modal-update-user').modal('hide');
                $('#modal-add-new-user').modal('hide');
                $('#modal-renew-password').modal('hide');
            }
        });
    }

    function checkUserName(username){
        let charArray = username.split('');
        for(let i = 0; i < charArray.length; i++){
            let ascii = charArray[i].charCodeAt(0);
            if((ascii >= 48 && ascii <= 57) || (ascii >= 65 && ascii <= 90) || (ascii >= 97 && ascii <= 122)){
                continue;
            }else{
                return false;
            }
        }
        return true;
    }

    function validatePassword (password){
        var passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{6,}$/g;
        var result = passwordRegex.test(password);
        return result;
    }

    function validateEmail(email){
        var emailPattern = /^\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/g;
        var result = emailPattern.test(email);
        return result;
    }

    function isContainUsername(username){
        let flag = true
        $.ajax({
            url: '/UsersController/containUsername?username='+username,
            type: 'get',
            dataType: 'json',
            async: false,
            success: function(response) {
                flag = response.result;
            }
        });
        return flag;
    }

    function isContainEmail(email){
        let flag = true
        $.ajax({
            url: '/UsersController/containEmail?email='+email,
            type: 'get',
            dataType: 'json',
            async: false,
            success: function(response) {
                flag = response.result;
            }
        });
        return flag;
    }

    function isContainEmailUpdateUser(id, email){
        let flag = true
        $.ajax({
            url: '/UsersController/containEmailWithUserId?email='+ email +'&id=' + id,
            type: 'get',
            dataType: 'json',
            async: false,
            success: function(response) {
                flag = response.result;
            }
        });
        return flag;
    }

    $( document ).ready(function() {

        $(".detail-user").on('click', function (){
            var userId = $(this).attr("data-userId");
            var token = $("#csrf-input").val();
            $.ajax({
                type: 'POST',
                url:'/UsersController/getDetailUserById',
                traditional: true,
                dataType : 'JSON',
                headers: {
                    'X-CSRF-Token': token
                },
                data: {
                    "userId" : userId
                },
                cache : true,
                async: false,
                success: function(response){
                    if(response!=null) {
                        console.log(response);
                        if (response.code == 0) {
                            let dataUser = response.data;
                            $("#detail-username").text(dataUser.username);
                            $("#detail-name").text(dataUser.name);
                            $("#detail-email").text(dataUser.email);
                            $("#userid-detail").val(userId);
                            $("#detail-role").text(dataUser.roleName);
                            if(dataUser.status == 1){
                                $("#detail-status").text("Hoạt động");
                            }else {
                                $("#detail-status").text("Khóa");
                            }

                            $('#modal-detail-user').modal('show');
                        } else {
                            //toast
                        }
                    }
                },
                error: function (e){
                    console.log(e);
                },
            });
        });

        $(".update-user").on('click', function(){
            var userId = $(this).attr("data-userId");
            var token = $("#csrf-input").val();
            $("#form-update-user input").val("");
            $.ajax({
                type: 'POST',
                url:'/UsersController/getUserById',
                traditional: true,
                dataType : 'JSON',
                headers: {
                    'X-CSRF-Token': token
                },
                data: {
                    "userId" : userId
                },
                cache : true,
                async: false,
                success: function(response){
                    if(response!=null) {
                        console.log(response);
                        if (response.code == 0) {

                            let dataUser = response.data;
                            let roleId = response.roleId;
                            $("#name-update").val(dataUser.name);
                            $("#email-update").val(dataUser.email);
                            $("#userid-update").val(userId);
                            $("#update-username").val(dataUser.username);
                            $("#role-update").val(roleId);
                            $("#status-update").val(dataUser.status);
                            $('#modal-update-user').modal('show');
                            removeTooltip("name-update");
                            removeTooltip("email-update");
                        } else {
                            //toast
                        }
                    }
                },
                error: function (e){
                    console.log(e);
                },
            });
        })

        $(".renew-password").on('click', function(){
            $("#password").val("");
            $("#passwordConfirm").val("");
            var userid = $(this).attr("data-userid");
            var userName = $(this).attr("data-username");
            // var name = $(this).attr("data-name");
            $("#username-renew-password").val(userName);
            // $("#name-renew-password").text(name);
            $("#userid-renew-password").val(userid);
            $("#renew-password-result").text("");
            $('#modal-renew-password').modal('show');
        })

        $('.form-control').click(function(e) {
            $("#renew-password-result").text("");
        });

        $(".detele-user").on('click', function(){
            var userId = $(this).attr("data-userid");
            var token = $("#csrf-input").val();
            var userName = $(this).attr("data-username");

            Swal.fire({
                title: "Bạn muốn xóa tài khoản " + userName + "?",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                cancelButtonText: "Hủy",
                confirmButtonText: "Xóa",
                allowOutsideClick: true,
                reverseButtons: true
            }).then((result) => {
                if (result.value) {
                    $.ajax({
                        type: 'POST',
                        url: '/UsersController/deleteUser',
                        traditional: true,
                        dataType: 'JSON',
                        headers: {
                            'X-CSRF-Token': token
                        },
                        data: {
                            "userId": userId,
                        },
                        cache: true,
                        async: false,
                        success: function (response) {
                            if (response) {
                                console.log(response);
                                if (response.code == 0) {
                                    Swal.fire("Thông báo", response.message, "success").then((result) => {
                                        location.reload();
                                    });
                                } else if (response.code == 1) {
                                    Swal.fire("Có lỗi xảy ra, vui lòng thử lại", "", "error");
                                }
                            }
                        },
                        error: function (e) {
                            console.log(e);
                            Swal.fire("Có lỗi xảy ra, vui lòng thử lại", "", "error");
                        },
                    })
                }
            })
        })
    });

    function addUser(){
        $('#modal-add-new-user').modal('show');
        removeTooltip("username-add");
        removeTooltip("name-add");
        removeTooltip("email-add");
        removeTooltip("password-add");
        removeTooltip("confirm-password-add");
    }
    function validateAddUser(){
        $("#is-valid-info-add").val(1);
        let check = true;
        let usernameAdd = $("#username-add").val();
        if(usernameAdd == null || usernameAdd.length <= 0){
            showTooltip("Tên đăng nhập không được để trống.", "username-add");
            check = false;
        }else {
            removeTooltip("username-add");
            if(!checkUserName(usernameAdd)){
                showTooltip("Tên đăng nhập không được chứa ký tự đặc biệt hoặc khoảng trắng.", "username-add");
                check = false;
            }else {
                removeTooltip("username-add");
                if(usernameAdd != null && usernameAdd.length > 0){
                    if(isContainUsername(usernameAdd)){
                        showTooltip("Tên đăng nhập đã tồn tại.", "username-add");
                        check = false;
                    }
                }else {
                    removeTooltip("username-add");
                }
            }
        }



        let nameAdd = $("#name-add").val();
        if(nameAdd == null || nameAdd.length <= 0){
            showTooltip("Tên người dùng không được để trống.", "name-add");
            check = false;
        }else {
            removeTooltip("name-add");
        }
        let emailAdd = $("#email-add").val();
        if(emailAdd == null || emailAdd.length <= 0){
            showTooltip("Email không được để trống.", "email-add");
            check = false;
        }else {
            removeTooltip("email-add");
            if(!validateEmail(emailAdd)){
                showTooltip("Email sai định dạng. Vui lòng thử lại.", "email-add");
                check = false;
            }else {
                removeTooltip("email-add");
                if(emailAdd != null && emailAdd.length > 0){
                    if(isContainEmail(emailAdd)){
                        showTooltip("Email đã tồn tại.", "email-add");
                        check = false;
                    }else {
                        removeTooltip("email-add");
                    }
                }
            }
        }

        let passwordAdd = $("#password-add").val();
        if(passwordAdd == "" || passwordAdd.length <= 0) {
            showTooltip("Mật khẩu không được để trống.", "password-add");
            check = false;
        }else {
            removeTooltip("password-add");
            if(!validatePassword(passwordAdd)){
                showTooltip("Mật khẩu tối thiểu 6 ký tự bao gồm ký tự số, ký tự hoa, ký tự thường và ký tự đặc biệt. Vui lòng thử lại.", "password-add");
                check = false;
            }else {
                removeTooltip("password-add");
            }
        }



        let confirmPasswordAdd = $("#confirm-password-add").val();
        if(confirmPasswordAdd == "") {
            showTooltip("Xác nhận mật khẩu không được để trống.", "confirm-password-add");
            check = false;
        }else {
            removeTooltip("confirm-password-add");
            if(passwordAdd != confirmPasswordAdd){
                showTooltip("Mật khẩu xác nhận không khớp. Vui lòng thử lại.", "confirm-password-add");
                check = false;
            }else {
                removeTooltip("confirm-password-add");
            }
        }



        if(check){

            $("#form-add-user").submit();
            $("#form-add-user input").val("");
        }
    }

    function validateRenewPassword() {
        let check = true;
        var token = $("#csrf-input").val();
        var password = $("#password-renew").val();
        var passwordConfirm = $("#passwordConfirm-renew").val();
        var userid = $("#userid-renew-password").val();

        if(password == "" || password.length <= 0) {
            showTooltip("Mật khẩu không được để trống.", "password-renew");
            check = false;
        }else {
            removeTooltip("password-renew");
            if(!validatePassword(password)){
                showTooltip("Mật khẩu tối thiểu 6 ký tự bao gồm ký tự số, ký tự hoa, ký tự thường và ký tự đặc biệt. Vui lòng thử lại.", "password-renew");
                check = false;
            }else {
                removeTooltip("password-renew");
            }
        }
        if(passwordConfirm == "") {
            showTooltip("Xác nhận mật khẩu không được để trống.", "passwordConfirm-renew");
            check = false;
        }else {
            removeTooltip("passwordConfirm-renew");
            if(password != passwordConfirm){
                showTooltip("Mật khẩu xác nhận không khớp. Vui lòng thử lại.", "passwordConfirm-renew");
                check = false;
            }else {
                removeTooltip("passwordConfirm-renew");
            }
        }

        if(check){
            $.ajax({
                type: 'POST',
                url: '/UsersController/renewPassword',
                traditional: true,
                dataType: 'JSON',
                headers: {
                    'X-CSRF-Token': token
                },
                data: {
                    "userId": userid,
                    "password": password,
                    "passwordConfirm": passwordConfirm,
                },
                cache: true,
                async: false,
                success: function (response) {
                    if (response) {
                        console.log(response);
                        if (response.code == 0) {
                            $('#modal-renew-password').modal('hide');
                            Swal.fire("Thông báo", response.message, "success").then((result) => {
                                location.reload();
                            });
                        } else if (response.code == 1) {
                            Swal.fire("Thông báo", response.message, "error").then((result) => {
                                location.reload();
                            });
                        }
                    }
                },
                error: function (e) {
                    console.log(e);
                    Swal.fire("Có lỗi xảy ra, vui lòng thử lại", "", "error");
                },
            })
        }
    }

    function validateUpdateUser(){
        $("#is-valid-info-update").val(1)
        var token = $("#csrf-input").val();
        let check = true;
        var userid = $("#userid-update").val();
        var name = $("#name-update").val();
        if(name == null || name.length <= 0){
            showTooltip("Tên người dùng không được để trống.", "name-update");
            check = false;
        }else {
            removeTooltip("name-update");
        }
        var email = $("#email-update").val();
        if(email == null || email.length <= 0){
            showTooltip("Email không được để trống.", "email-update");
            check = false;
        }else {
            removeTooltip("email-update");
            if(!validateEmail(email)){
                showTooltip("Email sai định dạng. Vui lòng thử lại.", "email-update");
                check = false;
            }else {
                removeTooltip("email-update");
                if(email != null && email.length > 0){
                    let checkEmail = isContainEmailUpdateUser(userid, email);
                    if(checkEmail == true){
                            showTooltip("Email đã tồn tại.", "email-update");
                            check = false;
                    }else {
                            removeTooltip("email-update");
                    }
                }
            }
        }

        var roleUpdate = $("#role-update").val();
        var statusUpdate = $("#status-update").val();
        if(check){
            $.ajax({
                type: 'POST',
                url: '/UsersController/updateUser',
                traditional: true,
                dataType: 'JSON',
                headers: {
                    'X-CSRF-Token': token
                },
                data: {
                    "userId": userid,
                    "name": name,
                    "email": email,
                    "roleId" : roleUpdate,
                    "status" : statusUpdate
                 },
                cache: true,
                async: false,
                success: function (response) {
                    if (response) {
                        console.log(response);
                        if (response.code==0){
                            $('#modal-update-user').modal('hide');
                            Swal.fire("Thông báo", response.message, "success").then((result) => {
                                location.reload();
                            });
                        } else if (response.code==1){
                            Swal.fire('Thông báo', response.message,'error')
                        }
                    }
                },
                error: function (e) {
                    console.log(e);
                    Swal.fire("Có lỗi xảy ra, vui lòng thử lại", "", "error");
                },
            })
        }
    }

    function update(){

        $('#modal-detail-user').modal('hide');
        var userId = $("#userid-detail").val();
        var token = $("#csrf-input").val();
        $("#form-update-user input").val("");
        $.ajax({
            type: 'POST',
            url:'/UsersController/getUserById',
            traditional: true,
            dataType : 'JSON',
            headers: {
                'X-CSRF-Token': token
            },
            data: {
                "userId" : userId
            },
            cache : true,
            async: false,
            success: function(response){
                if(response!=null) {
                    console.log(response);
                    if (response.code == 0) {
                        let dataUser = response.data;
                        let roleId = response.roleId;
                        $("#name-update").val(dataUser.name);
                        $("#email-update").val(dataUser.email);
                        $("#userid-update").val(userId);
                        $("#update-username").val(dataUser.username);
                        $("#role-update").val(roleId);
                        $("#status-update").val(dataUser.status);
                        $('#modal-update-user').modal('show');
                    } else {
                        //toast
                    }
                }
            },
            error: function (e){
                console.log(e);
            },
        });
    }
    function exportUser(){
        $('#mainForm').attr('action', '/UsersController/exportUser');
        $('#mainForm').submit();
        $('#mainForm').attr('action', '/UsersController/usersManager');

    }
</script>
</body>
</html>